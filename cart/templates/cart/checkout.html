{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Faulora Farm{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
/* === Global Styles === */
body {
    background: linear-gradient(180deg, #f3fff3 0%, #e8f5e8 100%);
    font-family: 'Poppins', sans-serif;
    color: #2e7d32;
    margin: 0;
    padding: 0;
    line-height: 1.6;
}

/* Checkout Container */
.checkout-container {
    max-width: 1000px;
    margin: 50px auto;
    background: linear-gradient(145deg, #ffffff, #f1f8e9);
    border-radius: 25px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    padding: 40px;
    border: 3px solid #c8e6c9;
}
.checkout-header {
    text-align: center;
    color: #1b5e20;
    margin-bottom: 30px;
    font-size: 2.5em;
    font-weight: 700;
}

/* Form Inputs */
input, textarea {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 2px solid #c8e6c9;
    border-radius: 10px;
}
input:focus, textarea:focus {
    border-color: #4caf50;
    outline: none;
}

/* Buttons */
.btn {
    background: linear-gradient(135deg, #4caf50, #2e7d32);
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
}
.btn:hover { background: linear-gradient(135deg, #2e7d32, #1b5e20); }
.btn-warning { background: linear-gradient(135deg, #ff9800, #f57c00); }

/* Payment Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
}
.modal-content {
    background: linear-gradient(145deg, #ffffff, #f1f8e9);
    margin: 15% auto;
    padding: 30px;
    border-radius: 20px;
    max-width: 450px;
    text-align: center;
}
.modal-content .close {
    background: #ffcb05;
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    cursor: pointer;
}
.modal-content .close:hover { background: #ffb300; }
</style>

<main>
    <div class="checkout-container">
        <h2 class="checkout-header"><i class="fas fa-credit-card"></i> Checkout</h2>

        {% if cart_items %}
        <form id="delivery-form" method="POST" action="{% url 'cart:checkout' %}">
            {% csrf_token %}
            <h3>Delivery Information</h3>
            <input type="text" name="full_name" placeholder="Full Name" required>
            <input type="email" name="email" placeholder="Email Address" required>
            <input type="tel" name="phone" placeholder="Phone Number (07XXXXXXXX)" required pattern="07[0-9]{8}">
            <textarea name="address" rows="3" placeholder="Delivery Address" required></textarea>

            <div style="display:flex; gap:15px; margin-top:15px;">
                <a href="{% url 'cart:cart_detail' %}" class="btn">Back to Cart</a>
                <button type="button" id="proceed-to-payment" class="btn">Proceed to Payment</button>
            </div>
        </form>

        <!-- Payment Section -->
        <div id="payment-section" style="display:none; margin-top:30px;">
            <h3>Payment Method</h3>
            <p>Total: <strong>KSh {{ total|floatformat:2 }}</strong></p>
            <button id="pay-with-mpesa" class="btn btn-warning"><i class="fas fa-mobile-alt"></i> Pay with M-Pesa</button>
        </div>

        <!-- Payment Modal -->
        <div id="payment-modal" class="modal">
            <div class="modal-content">
                <h3>Confirm Payment</h3>
                <p>Transaction of <strong>KSh {{ total|floatformat:2 }}</strong> to Faulora Farm</p>
                <button id="confirm-payment" class="btn">Confirm Payment</button>
                <button class="close">Cancel</button>
            </div>
        </div>

        {% else %}
        <p>Your cart is empty.</p>
        <a href="{% url 'products:product_list' %}" class="btn">Continue Shopping</a>
        {% endif %}
    </div>
</main>

<script>
// Show Payment Section
document.getElementById('proceed-to-payment').addEventListener('click', function() {
    const form = document.getElementById('delivery-form');
    if (form.checkValidity()) {
        document.getElementById('payment-section').style.display = 'block';
        this.style.display = 'none';
        document.getElementById('payment-section').scrollIntoView({behavior:'smooth'});
    } else {
        alert('Please fill in all delivery details.');
    }
});

// Open Modal
document.getElementById('pay-with-mpesa').addEventListener('click', function() {
    document.getElementById('payment-modal').style.display = 'block';
    document.getElementById('payment-modal').scrollIntoView({behavior:'smooth'});
});

// Confirm Payment
document.getElementById('confirm-payment').addEventListener('click', function() {
    document.getElementById('delivery-form').submit();
});

// Close Modal
document.querySelector('.close').addEventListener('click', function() {
    document.getElementById('payment-modal').style.display = 'none';
});
</script>
{% endblock %}
